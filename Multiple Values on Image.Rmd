---
title: "Grayscale image + scaling"
author: "Thomas Castro"
date: "11/2/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(reshape2)
library(png)

```

## Using a grayscale image map, much smaller

```{r}

wardMap <- readPNG("images_for_import/dc_wards.png")

# Grayscale image, so all three color layers are the same
# but we only need one.  We don't need the 4th layer,
# the alpha values, either.
wardMap <- wardMap[,,1]

# Turn the decimal values into integers on 256 scale
wardMap <- wardMap * 255

ward <- reshape2::melt(wardMap, 
                       varnames = c("imgY", "imgX"), 
                       value.name = "value")

# Check number of pixels by value
table(ward$value)

```

Set up ranges based on grayscale values in the image.  This example used grayscale, but a color scale could also be used.  I used GIMP, an open source image editor.

A short review of the process:

- Use 'fuzzy select' to choose the area/color.
- 'Grow' the selection by two pixels.
- Choose the color you want to make this area.
- Choose the PENCIL tool and select the brush size.
- Draw over that area.

The importance is that there are NOT pixels that are aliased.  They should be 'blocky' or 'jagged' since we're using the color of each pixel to assign a category.  

Another method of cleaning this up is to go to Image, Mode, Indexed, and then manually set the number of different colors used in the image.  This can highlight areas that may have antialiasing that may need to be removed, using the select/grow/paint method or another one.  Someone more skilled with using image editing software will probably laugh at my method, but I'd love to hear of another easier/faster way.


```{r}

ward <- ward %>% mutate(
  ward = case_when( value == 204 ~ "Ward 1",
                    value == 26  ~ "Ward 2",
                    value == 51  ~ "Ward 3",
                    value == 230 ~ "Ward 4",
                    value == 179 ~ "Ward 5",
                    value == 77  ~ "Ward 6",
                    value == 128 ~ "Ward 7",
                    value == 102 ~ "Ward 8"
                        ) ) %>% 
  drop_na()


```

The X and Y positions listed in the vets.csv file are based on a 1677 x 2100 map size.  The image size for the wards are different, so the values have to be scaled to match the 1677 x 2100 matrix.

```{r}

imageX = dim(wardMap)[2]
imageY = dim(wardMap)[1]

dataX = 1677
dataY = 2100

xScale = dataX / imageX
yScale = dataY / imageY

scale_convert <- reshape2::melt(matrix(0,dataX,dataY), 
                                varnames = c("xPos", "yPos"), 
                                value.name = "value")

scale_convert <- scale_convert %>% mutate(imgX = ceiling(xPos / xScale),
                                          imgY = ceiling(yPos / yScale)) %>% 
  select(-value)

```



```{r}

ward <- left_join(x = ward,
                  y = scale_convert,
                  by = c( "imgX" = "imgX", "imgY" = "imgY"))

max(ward$imgX)
max(ward$imgY)

max(ward$xPos)
max(ward$yPos)

# Just keep the X, Y, and ward number
ward <- ward %>%
  select(xPos, yPos, ward)

rm(wardMap, scale_convert)

```


```{r}

write_csv(ward, "csv_files/ward_table.csv")

```

### Add Ward column to dcPeople

```{r}

dcPeople <- read.csv("csv_files/dc_people.csv")

dcPeople <- left_join(x = dcPeople,
                      y = ward,
                      by = c( "xPos" = "xPos", "yPos" = "yPos"))

dcPeople %>% count()

sample_n(dcPeople, 30000)  %>% 
  ggplot(
    aes(x = xPos,
        y = -yPos,
        color = ward)
  ) + 
  geom_point(size = .33,
             alpha = 0.5) +
  theme_ipsum_ps() +
  labs(title = "DC population by ward",
       subtitle = "Based on grayscale image with several values",
       x = "pixel x-axis",
       y = "pixel y-axis",
       caption = "All DC population by Ward") +
  scale_color_manual(values=c("#553739",   # 1
                              "#955E42",   # 2
                              "#9C914F",   # 3
                              "#748E54",   # 4
                              "#748E54",   # 5
                              "#D4B483",   # 6
                              "#CAD49D",   # 7
                              "#56A3A6" )) # 8


```
